<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pre-screening Experiments</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --ink: #1e293b;
      --ink-muted: #64748b;
      --line: #e2e8f0;
      --brand: #9a7fe8;
      --brand-deep: #6f52bf;
      --ok: #166534;
      --warn: #9a3412;
      --bad: #991b1b;
      --shadow: 0 10px 30px -6px rgba(15, 23, 42, 0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Manrope", "Noto Sans SC", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1000px 520px at -5% -12%, #f6f0ff 0%, transparent 58%),
        radial-gradient(900px 500px at 110% -8%, #f1e9ff 0%, transparent 56%),
        linear-gradient(180deg, #f1f5f9 0%, #f8fafc 50%, #f8fafc 100%);
      line-height: 1.6;
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
    }
    .hero {
      background: linear-gradient(135deg, #a98cf0 0%, #8869dc 48%, #6f52bf 100%);
      color: #fff;
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--shadow);
    }
    .hero h1 { margin: 0 0 8px; font-size: 1.5rem; }
    .hero p { margin: 6px 0; opacity: 0.96; }
    .progress-box {
      margin-top: 14px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 999px;
      height: 12px;
      overflow: hidden;
    }
    .progress {
      width: 0;
      height: 100%;
      background: #fff;
      transition: width .25s ease;
    }
    .panel {
      margin-top: 16px;
      background: var(--surface);
      border: 1px solid #f1f5f9;
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
    }
    h2 { margin: 0 0 12px; font-size: 1.08rem; color: var(--brand-deep); }
    h3 { margin: 0; font-size: 1rem; }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    label.field {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--ink-muted);
      margin-bottom: 4px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      font: inherit;
      color: var(--ink);
      background: #fff;
    }
    .q {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      margin-top: 12px;
      background: #fff;
    }
    .q h3 { margin: 0 0 8px; }
    .opt {
      position: relative;
      display: block;
      margin: 8px 0;
      border: 1.5px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 12px 12px 12px 42px;
      font-weight: 700;
      cursor: pointer;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .opt:hover {
      border-color: #c4b5fd;
      box-shadow: 0 6px 14px rgba(111, 82, 191, 0.12);
    }
    .opt input, .opt input[type="checkbox"] {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      margin: 0;
    }
    .opt.selected {
      border-color: #8b5cf6;
      background: linear-gradient(180deg, #f7f3ff 0%, #f3edff 100%);
      box-shadow: 0 8px 16px rgba(111, 82, 191, 0.16);
    }
    .vocab-q h3 {
      margin-bottom: 12px;
      font-size: 1.05rem;
    }
    .vocab-choice-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .vocab-choice {
      position: relative;
      display: block;
      border: 1.5px solid var(--line);
      border-radius: 14px;
      background: #ffffff;
      padding: 16px 10px;
      text-align: center;
      font-weight: 800;
      font-size: 1.05rem;
      cursor: pointer;
      user-select: none;
      transition: border-color .18s ease, box-shadow .18s ease, transform .12s ease;
      min-height: 64px;
    }
    .vocab-choice:hover {
      border-color: #c4b5fd;
      box-shadow: 0 6px 14px rgba(111, 82, 191, 0.14);
      transform: translateY(-1px);
    }
    .vocab-choice input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      width: 0;
      height: 0;
    }
    .vocab-choice input:checked + span {
      color: #4c1d95;
    }
    .vocab-choice input:checked + span::after {
      content: "✓";
      margin-left: 8px;
      font-weight: 900;
    }
    .vocab-choice:has(input:checked) {
      border-color: #8b5cf6;
      background: linear-gradient(180deg, #f7f3ff 0%, #f3edff 100%);
      box-shadow: 0 8px 16px rgba(111, 82, 191, 0.18);
    }
    .vocab-choice.selected {
      border-color: #8b5cf6;
      background: linear-gradient(180deg, #f7f3ff 0%, #f3edff 100%);
      box-shadow: 0 8px 16px rgba(111, 82, 191, 0.18);
    }
    .two-col {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      text-decoration: none;
      border: 1px solid transparent;
      cursor: pointer;
      font: inherit;
    }
    .btn-primary {
      background: linear-gradient(130deg, var(--brand-deep), var(--brand));
      color: #fff;
      box-shadow: 0 8px 20px rgba(154, 127, 232, 0.25);
    }
    .btn-light {
      background: #fff;
      color: var(--ink);
      border-color: var(--line);
    }
    .btn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }
    .tip {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--ink-muted);
    }
    .error {
      margin-top: 10px;
      color: var(--bad);
      font-size: 0.92rem;
      font-weight: 600;
    }
    .upload-status {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      border: 1px solid var(--line);
      background: #f8fafc;
      color: var(--ink-muted);
    }
    .upload-status.ok {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: var(--ok);
    }
    .upload-status.warn {
      background: #fff7ed;
      border-color: #fed7aa;
      color: var(--warn);
    }
    .upload-status.bad {
      background: #fef2f2;
      border-color: #fecaca;
      color: var(--bad);
    }
    .result {
      margin-top: 16px;
      border-radius: 14px;
      padding: 14px;
      border: 1px solid var(--line);
      background: #fff;
    }
    .result.pass {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: var(--ok);
    }
    .result.fail {
      background: #fef2f2;
      border-color: #fecaca;
      color: var(--bad);
    }
    .result h3 { margin: 0 0 6px; }
    .hint { font-size: 0.85rem; color: var(--ink-muted); }
    .q12-note {
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #f8fafc;
    }
    .submit-progress {
      margin-top: 12px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fcfbff;
    }
    .submit-progress[hidden] { display: none; }
    .submit-progress p {
      margin: 0 0 8px;
      font-size: 0.9rem;
      color: var(--ink-muted);
      font-weight: 600;
    }
    .submit-progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #eee8ff;
      overflow: hidden;
    }
    .submit-progress-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(130deg, var(--brand-deep), var(--brand));
      transition: width .25s ease;
    }
    @media (max-width: 760px) {
      .grid, .two-col { grid-template-columns: 1fr; }
      .vocab-choice-grid { grid-template-columns: 1fr; }
      .wrap { padding: 14px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <h1>Pre-screening Experiments / 预筛选实验</h1>
      <p>本页面题目分为两部分：汉语学习背景信息 + 双字词判断（是/否）。</p>
      <p>Scoring rule: vocabulary section total 60 points; score <strong>greater than 25</strong> is considered passed.</p>
      <div class="progress-box"><div id="progressBar" class="progress"></div></div>
      <p id="progressText" style="margin:8px 0 0;font-size:0.9rem;">0 / 74 answered</p>
    </section>

    <section class="panel">
      <h2>自动上传设置 / Auto Upload Destination</h2>
      <p class="tip">上传地址已固定为研究团队 Webhook，无需手动配置。</p>
      <div class="actions">
        <button id="retryUploadBtn" class="btn btn-light" type="button">重传失败记录 / Retry Pending Uploads</button>
      </div>
      <p class="tip">提交答卷时会自动上传；若网络失败会先本地排队，之后可点击“重传失败记录”。</p>
      <p id="uploadStatus" class="upload-status">上传状态：固定上传地址已启用。</p>
    </section>

    <form id="quizForm" class="panel">
      <h2>Part A. Chinese Learner Background / 汉语学习背景</h2>

      <div class="q" data-bg="1">
        <h3>1. Name (姓名) <span class="hint">*</span></h3>
        <input name="q1_name" required />
      </div>

      <div class="q" data-bg="2">
        <h3>2. E-mail (邮箱) <span class="hint">*</span></h3>
        <input name="q2_email" type="email" required />
        <label class="field" for="q2_payment_method" style="margin-top:10px;">Payment 收款方式 <span class="hint">*</span></label>
        <select id="q2_payment_method" name="q2_payment_method" required>
          <option value="">请选择 / Select</option>
          <option value="微信">微信</option>
          <option value="支付宝">支付宝</option>
          <option value="PayPal">PayPal</option>
          <option value="Apple Pay">Apple Pay</option>
        </select>
        <label class="field" for="q2_payment_account" style="margin-top:10px;">收款账号 <span class="hint">*</span></label>
        <input id="q2_payment_account" name="q2_payment_account" placeholder="请输入收款账号 / Enter payment account" required />
      </div>

      <div class="q" data-bg="3">
        <h3>3. Age (年龄) <span class="hint">*</span></h3>
        <input name="q3_age" type="number" min="10" max="90" required />
      </div>

      <div class="q" data-bg="4">
        <h3>4. Gender (性别) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q4_gender" value="Male (男)" required />Male (男)</label>
        <label class="opt"><input type="radio" name="q4_gender" value="Female (女)" />Female (女)</label>
        <label class="opt"><input type="radio" name="q4_gender" value="Other (其他)" />Other (其他)</label>
      </div>

      <div class="q" data-bg="5">
        <h3>5. Nationality (国籍) <span class="hint">*</span></h3>
        <input name="q5_nationality" required />
      </div>

      <div class="q" data-bg="6">
        <h3>6. Native language(s) (multiple answers allowed) | 母语 (可多种) <span class="hint">*</span></h3>
        <input name="q6_native_languages" required placeholder="e.g., English; Spanish" />
      </div>

      <div class="q" data-bg="7">
        <h3>7. Have you ever been to China? (是否来过中国？) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q7_been_china" value="Yes (是)" required />Yes (是)</label>
        <label class="opt"><input type="radio" name="q7_been_china" value="No (否)" />No (否)</label>
        <label class="field" for="q7_detail" style="margin-top:10px;">Purpose and duration (目的与时长)</label>
        <input id="q7_detail" name="q7_detail" placeholder="Optional" />
      </div>

      <div class="q" data-bg="8">
        <h3>8. Total length of Chinese learning (excluding interruptions) | 累计学习汉语的时长 (不含中断时间) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q8_learning_length" value="Less than 1 year (少于 1 年)" required />Less than 1 year (少于 1 年)</label>
        <label class="opt"><input type="radio" name="q8_learning_length" value="1–2 years (1–2 年)" />1–2 years (1–2 年)</label>
        <label class="opt"><input type="radio" name="q8_learning_length" value="2–4 years (2–4 年)" />2–4 years (2–4 年)</label>
        <label class="opt"><input type="radio" name="q8_learning_length" value="4–6 years (4–6 年)" />4–6 years (4–6 年)</label>
        <label class="opt"><input type="radio" name="q8_learning_length" value="More than 6 years (6 年以上)" />More than 6 years (6 年以上)</label>
      </div>

      <div class="q" data-bg="9">
        <h3>9. Main learning contexts (multiple answers allowed) | 学习汉语的主要方式或场所 (可多选) <span class="hint">*</span></h3>
        <label class="opt"><input type="checkbox" name="q9_contexts" value="University in home country (本国高校)" />University in home country (本国高校)</label>
        <label class="opt"><input type="checkbox" name="q9_contexts" value="University in China (中国高校)" />University in China (中国高校)</label>
        <label class="opt"><input type="checkbox" name="q9_contexts" value="Language institute (语言培训机构)" />Language institute (语言培训机构)</label>
        <label class="opt"><input type="checkbox" name="q9_contexts" value="Online courses (线上课程)" />Online courses (线上课程)</label>
        <label class="opt"><input type="checkbox" name="q9_contexts" value="Self-study (自学)" />Self-study (自学)</label>
        <label class="opt"><input type="checkbox" id="q9_other_chk" name="q9_contexts" value="Other (其他)" />Other (其他)</label>
        <label class="field" for="q9_other" style="margin-top:10px;">Other details (其他说明)</label>
        <input id="q9_other" name="q9_other" placeholder="Optional" />
      </div>

      <div class="q" data-bg="10">
        <h3>10. Current Chinese proficiency (self-rated) | 目前的汉语水平 (自评) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Beginner (初级入门)" required />Beginner (初级入门)</label>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Elementary (基础)" />Elementary (基础)</label>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Intermediate (中级)" />Intermediate (中级)</label>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Advanced (高级)" />Advanced (高级)</label>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Proficient (精通级)" />Proficient (精通级)</label>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Near-native (接近母语水平)" />Near-native (接近母语水平)</label>
      </div>

      <div class="q" data-bg="11">
        <h3>11. Highest HSK level obtained (已获得的最高HSK等级) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q11_hsk" value="Never taken (未参加过)" required />Never taken (未参加过)</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 1" />HSK 1</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 2" />HSK 2</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 3" />HSK 3</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 4" />HSK 4</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 5" />HSK 5</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 6" />HSK 6</label>
      </div>

      <div class="q" data-bg="12">
        <h3>12. Please upload your Chinese proficiency certificate, ideally the HSK (请上传您的汉语水平证书，最好是HSK证书) <span class="hint">*</span></h3>
        <div class="q12-note">
          <p class="hint" style="margin:0 0 8px;">由于 Google Sheet 文件大小限制，本页面不支持直接上传文件。</p>
          <label class="opt"><input type="checkbox" name="q12_send_by_email" value="yes" />我将通过邮件附件发送证书 / I will send the certificate as an email attachment</label>
          <label class="field" for="q12_certificate_url" style="margin-top:8px;">或填写可访问的在线地址 / Or provide an accessible URL</label>
          <input id="q12_certificate_url" name="q12_certificate_url" placeholder="https://..." />
          <p class="hint" style="margin:8px 0 0;">第12题要求：至少满足一种方式（邮件附件 或 在线地址）。</p>
        </div>
      </div>

      <div class="q" data-bg="13">
        <h3>13. Date of the most recent passed HSK test (Year/Month) | 最近一次通过HSK的时间 (年/月)</h3>
        <input name="q13_hsk_date" placeholder="Optional: e.g., 2025/10" />
      </div>

      <div class="q" data-bg="14">
        <h3>14. Primary motivation for learning Chinese (学习汉语的主要动机) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q14_motivation" value="Academic (学业)" required />Academic (学业)</label>
        <label class="opt"><input type="radio" name="q14_motivation" value="Work (工作)" />Work (工作)</label>
        <label class="opt"><input type="radio" name="q14_motivation" value="Personal interest (个人兴趣)" />Personal interest (个人兴趣)</label>
        <label class="opt"><input type="radio" name="q14_motivation" value="Other (其他)" />Other (其他)</label>
      </div>

      <h2 style="margin-top:18px;">Part B. Two-Character Vocabulary Check / 双字词判断（是/否）</h2>
      <div id="vocabQuestions"></div>

      <div class="actions">
        <button class="btn btn-primary" type="submit">计算得分 / Calculate Score</button>
      </div>
      <div id="submitProgressBox" class="submit-progress" hidden>
        <p id="submitProgressText">处理中...</p>
        <div class="submit-progress-bar">
          <div id="submitProgressFill" class="submit-progress-fill"></div>
        </div>
      </div>
      <p class="tip">测试信息会自动存储在 Google Sheet。</p>
      <p class="tip">提交后系统会生成结果。请点击“通过邮箱发送结果”把考生信息和答题结果发送给研究团队。</p>
      <p id="errorMsg" class="error" hidden></p>

      <div id="resultBox" class="result" hidden>
        <h3 id="resultTitle"></h3>
        <p id="resultText"></p>
        <div class="actions">
          <a id="sendEmailBtn" class="btn btn-primary" href="#">通过邮箱发送结果 / Send Result via Email</a>
          <a id="nextBtn" class="btn btn-light" href="./index.html">返回主页面 / Back to Main Page</a>
        </div>
      </div>
    </form>
  </div>

  <script>
    const VOCAB_WORDS = [
      "涟漪", "熟悉", "璀璨", "缤纂", "慷慨", "朦胧", "恍惚", "挫治", "痊愈", "抹哦",
      "咸裕", "问题", "匍匐", "狰狞", "憧憬", "祈祷", "呻椒", "寂寞", "囊港", "烹饪",
      "涵浅", "瑕疵", "巅妾", "漆蝠", "襁褓", "傀儡", "晴榻", "瘫痪", "磷祥", "俸禄",
      "抒汞", "喉咙", "滂沱", "骄傲", "卑鄙", "亦筷", "脂肪", "唠叨", "糖描", "囫囵",
      "淘汰", "愤怒", "邋遢", "裳妊", "亵渎", "诠疮", "蹉跎", "蹂躏", "契砣", "贿赂",
      "瘟疫", "咳嗽", "鹤棋", "羡慕", "颔味", "吩咐", "掌握", "惆怅", "晶嫩", "徘徊"
    ];
    const VOCAB_ANSWER_KEY = [
      true, true, true, false, true, true, true, false, true, false,
      false, true, true, true, true, true, false, true, false, true,
      false, true, false, false, true, true, false, true, false, true,
      false, true, true, true, true, false, true, true, false, true,
      true, true, true, false, true, false, true, true, false, true,
      true, true, false, true, false, true, true, true, false, true
    ];

    const form = document.getElementById("quizForm");
    const errorMsg = document.getElementById("errorMsg");
    const resultBox = document.getElementById("resultBox");
    const resultTitle = document.getElementById("resultTitle");
    const resultText = document.getElementById("resultText");
    const sendEmailBtn = document.getElementById("sendEmailBtn");
    const nextBtn = document.getElementById("nextBtn");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const retryUploadBtn = document.getElementById("retryUploadBtn");
    const uploadStatus = document.getElementById("uploadStatus");
    const vocabQuestionsEl = document.getElementById("vocabQuestions");
    const submitBtn = form.querySelector('button[type="submit"]');
    const submitProgressBox = document.getElementById("submitProgressBox");
    const submitProgressText = document.getElementById("submitProgressText");
    const submitProgressFill = document.getElementById("submitProgressFill");

    const FIRST_VOCAB_TOPIC = 15;
    const TOTAL_QUESTIONS = VOCAB_WORDS.length;
    const PASS_SCORE = 25;
    const BACKGROUND_PROGRESS_TOTAL = 14;
    const UPLOAD_QUEUE_KEY = "preScreenUploadQueue";
    const FIXED_UPLOAD_ENDPOINT = "https://script.google.com/macros/s/AKfycbznGbiTo1433zPLbHKUtsJnrmsjpcB0-uZAgKQd3wagPpY3PFVFzRurokxdLzDnOmviMQ/exec";

    function renderVocabQuestions() {
      vocabQuestionsEl.innerHTML = VOCAB_WORDS.map((word, idx) => {
        const topic = FIRST_VOCAB_TOPIC + idx;
        return `
          <div class="q vocab-q" data-topic="${topic}" data-word="${word}">
            <h3>${topic}. ${word}</h3>
            <div class="vocab-choice-grid">
              <label class="vocab-choice">
                <input type="radio" name="vocab_${topic}" value="Yes (是)" required />
                <span>Yes (是)</span>
              </label>
              <label class="vocab-choice">
                <input type="radio" name="vocab_${topic}" value="No (否)" />
                <span>No (否)</span>
              </label>
            </div>
          </div>
        `;
      }).join("");
    }

    function setUploadStatus(message, type = "") {
      uploadStatus.className = `upload-status ${type}`.trim();
      uploadStatus.textContent = message;
    }

    function getQueue() {
      try {
        return JSON.parse(localStorage.getItem(UPLOAD_QUEUE_KEY) || "[]");
      } catch (_) {
        return [];
      }
    }

    function saveQueue(queue) {
      localStorage.setItem(UPLOAD_QUEUE_KEY, JSON.stringify(queue));
    }

    function enqueueResult(resultData) {
      try {
        const queue = getQueue();
        queue.push(resultData);
        saveQueue(queue);
        return queue.length;
      } catch (_) {
        return -1;
      }
    }

    async function uploadToEndpoint(payload) {
      const endpoint = FIXED_UPLOAD_ENDPOINT;
      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error(`http-${response.status}`);
        }
        return { ok: true, verified: true };
      } catch (_) {
        try {
          await fetch(endpoint, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(payload)
          });
          return { ok: true, verified: false, reason: "opaque-no-cors" };
        } catch (_) {
          return { ok: false, reason: "network-error" };
        }
      }
    }

    async function retryPendingUploads() {
      const queue = getQueue();
      if (!queue.length) {
        setUploadStatus("没有待重传记录。", "ok");
        return;
      }
      const remaining = [];
      let successCount = 0;
      let unverifiedCount = 0;
      for (const item of queue) {
        const res = await uploadToEndpoint(item);
        if (res.ok) {
          if (res.verified === false) {
            unverifiedCount += 1;
          } else {
            successCount += 1;
          }
        } else {
          remaining.push(item);
        }
      }
      saveQueue(remaining);
      if (remaining.length === 0) {
        if (unverifiedCount > 0) {
          setUploadStatus(`重传完成：已验证成功 ${successCount} 条，已发送但不可验证 ${unverifiedCount} 条（常见于跨域限制）。`, "ok");
        } else {
          setUploadStatus(`重传完成：${successCount} 条全部成功。`, "ok");
        }
      } else {
        setUploadStatus(`重传完成：已验证成功 ${successCount} 条，已发送但不可验证 ${unverifiedCount} 条，失败 ${remaining.length} 条。`, "warn");
      }
    }

    function checkBackgroundRequired() {
      if (!form.q1_name.value.trim()) return "请填写第1题姓名。";
      if (!form.q2_email.value.trim()) return "请填写第2题邮箱。";
      if (!form.q2_payment_method.value.trim()) return "请在第2题选择收款方式。";
      if (!form.q2_payment_account.value.trim()) return "请在第2题填写收款账号。";
      if (!form.q3_age.value.trim()) return "请填写第3题年龄。";
      if (!form.querySelector('input[name="q4_gender"]:checked')) return "请完成第4题性别。";
      if (!form.q5_nationality.value.trim()) return "请填写第5题国籍。";
      if (!form.q6_native_languages.value.trim()) return "请填写第6题母语。";
      if (!form.querySelector('input[name="q7_been_china"]:checked')) return "请完成第7题是否来过中国。";
      if (!form.querySelector('input[name="q8_learning_length"]:checked')) return "请完成第8题学习时长。";
      if (form.querySelectorAll('input[name="q9_contexts"]:checked').length === 0) return "请至少选择第9题一个学习场景。";
      if (!form.querySelector('input[name="q10_proficiency"]:checked')) return "请完成第10题自评水平。";
      if (!form.querySelector('input[name="q11_hsk"]:checked')) return "请完成第11题HSK等级。";
      const q12SendByEmail = !!form.querySelector('input[name="q12_send_by_email"]:checked');
      const q12Url = form.q12_certificate_url.value.trim();
      if (!q12SendByEmail && !q12Url) return "请完成第12题：邮件附件发送或填写在线地址（至少一种）。";
      if (q12Url && !(q12Url.startsWith("http://") || q12Url.startsWith("https://"))) return "第12题在线地址格式需以 http:// 或 https:// 开头。";
      if (!form.querySelector('input[name="q14_motivation"]:checked')) return "请完成第14题学习动机。";
      return "";
    }

    function getBackgroundAnsweredCount() {
      let answered = 0;
      if (form.q1_name.value.trim()) answered += 1;
      if (form.q2_email.value.trim() && form.q2_payment_method.value.trim() && form.q2_payment_account.value.trim()) answered += 1;
      if (form.q3_age.value.trim()) answered += 1;
      if (form.querySelector('input[name="q4_gender"]:checked')) answered += 1;
      if (form.q5_nationality.value.trim()) answered += 1;
      if (form.q6_native_languages.value.trim()) answered += 1;
      if (form.querySelector('input[name="q7_been_china"]:checked')) answered += 1;
      if (form.querySelector('input[name="q8_learning_length"]:checked')) answered += 1;
      if (form.querySelectorAll('input[name="q9_contexts"]:checked').length > 0) answered += 1;
      if (form.querySelector('input[name="q10_proficiency"]:checked')) answered += 1;
      if (form.querySelector('input[name="q11_hsk"]:checked')) answered += 1;
      const q12SendByEmail = !!form.querySelector('input[name="q12_send_by_email"]:checked');
      const q12Url = form.q12_certificate_url.value.trim();
      if (q12SendByEmail || q12Url) answered += 1;
      if (form.q13_hsk_date.value.trim()) answered += 1;
      if (form.querySelector('input[name="q14_motivation"]:checked')) answered += 1;
      return answered;
    }

    function updateProgress() {
      let vocabAnswered = 0;
      for (let i = 0; i < VOCAB_WORDS.length; i++) {
        const topic = FIRST_VOCAB_TOPIC + i;
        if (form.querySelector(`input[name="vocab_${topic}"]:checked`)) vocabAnswered += 1;
      }
      const backgroundAnswered = getBackgroundAnsweredCount();
      const totalAnswered = backgroundAnswered + vocabAnswered;
      const totalCount = BACKGROUND_PROGRESS_TOTAL + TOTAL_QUESTIONS;
      const pct = Math.round((totalAnswered / totalCount) * 100);
      progressBar.style.width = `${pct}%`;
      progressText.textContent = `${totalAnswered} / ${totalCount} answered`;
    }

    function refreshVocabSelectionStyles() {
      document.querySelectorAll(".vocab-q").forEach((q) => {
        q.querySelectorAll(".vocab-choice").forEach((label) => label.classList.remove("selected"));
        const checked = q.querySelector('input[type="radio"]:checked');
        if (checked && checked.parentElement && checked.parentElement.classList.contains("vocab-choice")) {
          checked.parentElement.classList.add("selected");
        }
      });
    }

    function refreshGeneralOptionStyles() {
      document.querySelectorAll(".q:not(.vocab-q) .opt").forEach((label) => {
        const input = label.querySelector("input");
        if (input && input.checked) {
          label.classList.add("selected");
        } else {
          label.classList.remove("selected");
        }
      });
    }

    function setSubmitProgress(percent, text) {
      submitProgressBox.hidden = false;
      submitProgressFill.style.width = `${Math.max(0, Math.min(100, percent))}%`;
      submitProgressText.textContent = text;
    }

    function resetSubmitProgress() {
      submitProgressBox.hidden = true;
      submitProgressFill.style.width = "0%";
      submitProgressText.textContent = "处理中...";
    }

    function getBeijingTimestamp() {
      const parts = new Intl.DateTimeFormat("sv-SE", {
        timeZone: "Asia/Shanghai",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      }).formatToParts(new Date()).reduce((acc, part) => {
        if (part.type !== "literal") acc[part.type] = part.value;
        return acc;
      }, {});

      return `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}+08:00`;
    }

    retryUploadBtn.addEventListener("click", retryPendingUploads);
    form.addEventListener("change", () => {
      updateProgress();
      refreshVocabSelectionStyles();
      refreshGeneralOptionStyles();
    });
    form.addEventListener("input", updateProgress);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorMsg.hidden = true;
      resultBox.hidden = true;
      submitBtn.disabled = true;
      setSubmitProgress(6, "正在校验必填信息...");
      try {

        const bgError = checkBackgroundRequired();
        if (bgError) {
          errorMsg.textContent = bgError;
          errorMsg.hidden = false;
          submitBtn.disabled = false;
          resetSubmitProgress();
          return;
        }

        for (let i = 0; i < VOCAB_WORDS.length; i++) {
          const topic = FIRST_VOCAB_TOPIC + i;
          if (!form.querySelector(`input[name="vocab_${topic}"]:checked`)) {
            errorMsg.textContent = `请完成第 ${topic} 题后再提交。`;
            errorMsg.hidden = false;
            submitBtn.disabled = false;
            resetSubmitProgress();
            return;
          }
        }
        setSubmitProgress(28, "正在计算得分...");

        setSubmitProgress(38, "正在整理提交内容...");

        const q12SendByEmail = !!form.querySelector('input[name="q12_send_by_email"]:checked');
        const q12Url = form.q12_certificate_url.value.trim();
        const q12Methods = [];
        if (q12SendByEmail) q12Methods.push("Email attachment / 邮件附件");
        if (q12Url) q12Methods.push(`Online URL / 在线地址: ${q12Url}`);

        const candidate = {
        name: form.q1_name.value.trim(),
        email: form.q2_email.value.trim(),
        paymentMethod: form.q2_payment_method.value.trim(),
        paymentAccount: form.q2_payment_account.value.trim(),
        age: form.q3_age.value.trim(),
        gender: form.querySelector('input[name="q4_gender"]:checked').value,
        nationality: form.q5_nationality.value.trim(),
        nativeLanguages: form.q6_native_languages.value.trim(),
        beenToChina: form.querySelector('input[name="q7_been_china"]:checked').value,
        chinaVisitDetail: form.q7_detail.value.trim(),
        learningLength: form.querySelector('input[name="q8_learning_length"]:checked').value,
        learningContexts: Array.from(form.querySelectorAll('input[name="q9_contexts"]:checked')).map((el) => el.value),
        learningContextsOther: form.q9_other.value.trim(),
        proficiency: form.querySelector('input[name="q10_proficiency"]:checked').value,
        highestHSK: form.querySelector('input[name="q11_hsk"]:checked').value,
        certificateInfo: q12Methods.join(" | "),
        latestHSKDate: form.q13_hsk_date.value.trim(),
        motivation: form.querySelector('input[name="q14_motivation"]:checked').value,
        wechat: ""
      };

        const vocabAnswers = [];
        let correctCount = 0;
        for (let i = 0; i < VOCAB_WORDS.length; i++) {
          const topic = FIRST_VOCAB_TOPIC + i;
          const word = VOCAB_WORDS[i];
          const chosen = form.querySelector(`input[name="vocab_${topic}"]:checked`).value;
          const chosenYes = chosen === "Yes (是)";
          const expectedYes = VOCAB_ANSWER_KEY[i];
          const isCorrect = chosenYes === expectedYes;
          if (isCorrect) correctCount += 1;
          vocabAnswers.push({
            question: topic,
            word,
            chosen,
            correct: expectedYes ? "Yes (是)" : "No (否)",
            isCorrect
          });
        }

        const score = correctCount;
        const total = TOTAL_QUESTIONS;
        const passed = score > PASS_SCORE;

        const submittedAt = getBeijingTimestamp();
        const uploadPayload = {
          status: passed ? "pass" : "fail",
          score,
          total,
          passThreshold: `>${PASS_SCORE}`,
          candidate,
          answers: vocabAnswers,
          submittedAt
        };

        const resultData = {
          status: uploadPayload.status,
          score: uploadPayload.score,
          total: uploadPayload.total,
          passThreshold: uploadPayload.passThreshold,
          candidate,
          answers: uploadPayload.answers,
          submittedAt
        };
        setSubmitProgress(48, "正在保存本地结果...");

        localStorage.setItem("preScreenResult", JSON.stringify(resultData));

        setSubmitProgress(70, "正在上传到 Google Sheet...");
        const uploadRes = await uploadToEndpoint(uploadPayload);
        if (uploadRes.ok) {
          if (uploadRes.verified === false) {
            setUploadStatus("自动上传已发送，但浏览器无法验证响应（常见于跨域限制）。建议到数据端确认是否入库。", "warn");
          } else {
            setUploadStatus("自动上传成功。", "ok");
          }
        } else {
          const pendingCount = enqueueResult(resultData);
          if (pendingCount === -1) {
            setUploadStatus("自动上传失败，且本地缓存空间不足。请在网络稳定时重试提交。", "bad");
          } else {
            setUploadStatus(`自动上传失败，结果已加入待上传队列（${pendingCount} 条）。`, "bad");
          }
        }
        setSubmitProgress(86, "正在生成结果页面...");

        const mailSubject = passed
          ? `Pre-screening PASSED | ${candidate.name} | Score ${score}/${total}`
          : `Pre-screening FAILED | ${candidate.name} | Score ${score}/${total}`;

        const bgLines = [
        `Q1 Name: ${candidate.name}`,
        `Q2 Email: ${candidate.email}`,
        `Q2 Payment method: ${candidate.paymentMethod}`,
        `Q2 Payment account: ${candidate.paymentAccount}`,
        `Q3 Age: ${candidate.age}`,
        `Q4 Gender: ${candidate.gender}`,
        `Q5 Nationality: ${candidate.nationality}`,
        `Q6 Native languages: ${candidate.nativeLanguages}`,
        `Q7 Been to China: ${candidate.beenToChina}`,
        `Q7 Detail: ${candidate.chinaVisitDetail || "N/A"}`,
        `Q8 Learning length: ${candidate.learningLength}`,
        `Q9 Contexts: ${candidate.learningContexts.join("; ")}${candidate.learningContextsOther ? ` | Other: ${candidate.learningContextsOther}` : ""}`,
        `Q10 Proficiency: ${candidate.proficiency}`,
        `Q11 Highest HSK: ${candidate.highestHSK}`,
        `Q12 Certificate info: ${candidate.certificateInfo || "N/A"}`,
        `Q13 Latest passed HSK date: ${candidate.latestHSKDate || "N/A"}`,
        `Q14 Motivation: ${candidate.motivation}`
      ].join("\n");

        const answerLines = vocabAnswers
          .map((a) => `Q${a.question} ${a.word}: chosen=${a.chosen}, correct=${a.correct}, result=${a.isCorrect ? "correct" : "wrong"}`)
          .join("\n");

        const mailBody = [
        "Pre-screening Result",
        "-------------------",
        `Status: ${passed ? "PASSED" : "FAILED"}`,
        `Score: ${score}/${total}`,
        `Rule: score > ${PASS_SCORE} means pass.`,
        "",
        "Background Information",
        bgLines,
        "",
        "Vocabulary Answers",
        answerLines,
        "",
        `Submitted At: ${resultData.submittedAt}`
      ].join("\n");

        sendEmailBtn.href = `mailto:liuhuanpsylanguage@foxmail.com?subject=${encodeURIComponent(mailSubject)}&body=${encodeURIComponent(mailBody)}`;

        if (passed) {
          resultBox.className = "result pass";
          resultTitle.textContent = `预筛选通过 / Passed (${score}/${total})`;
          resultText.textContent = "恭喜！您可以进入 Step 3 进行正式实验。点击下方按钮返回主页面并继续 Step 3。";
          nextBtn.href = "./index.html#step3-section";
          nextBtn.textContent = "进入 Step 3 / Go to Step 3";
        } else {
          resultBox.className = "result fail";
          resultTitle.textContent = `预筛选未通过 / Not Passed (${score}/${total})`;
          resultText.textContent = "很抱歉，您本次预筛选未通过，不能进行实验3。后续如有其他实验，欢迎再次参与。";
          nextBtn.href = "./index.html";
          nextBtn.textContent = "返回主页面 / Back to Main Page";
        }

        setSubmitProgress(100, "处理完成");
        resultBox.hidden = false;
        resultBox.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => {
          resetSubmitProgress();
          submitBtn.disabled = false;
        }, 600);
      } catch (_) {
        errorMsg.textContent = "处理过程中发生错误，请稍后重试。";
        errorMsg.hidden = false;
        resetSubmitProgress();
        submitBtn.disabled = false;
      }
    });

    renderVocabQuestions();
    const queued = getQueue().length;
    setUploadStatus(
      queued
        ? `固定上传地址已启用。当前有 ${queued} 条待上传记录。`
        : "固定上传地址已启用。"
    );
    updateProgress();
    refreshVocabSelectionStyles();
    refreshGeneralOptionStyles();
  </script>
</body>
</html>
