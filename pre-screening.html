<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pre-screening Experiments</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;700;800&display=swap"
    rel="stylesheet" />
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --ink: #1e293b;
      --ink-muted: #64748b;
      --line: #e2e8f0;
      --brand: #9a7fe8;
      --brand-deep: #6f52bf;
      --ok: #166534;
      --warn: #9a3412;
      --bad: #991b1b;
      --shadow: 0 10px 30px -6px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Manrope", "Noto Sans SC", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1000px 520px at -5% -12%, #f6f0ff 0%, transparent 58%),
        radial-gradient(900px 500px at 110% -8%, #f1e9ff 0%, transparent 56%),
        linear-gradient(180deg, #f1f5f9 0%, #f8fafc 50%, #f8fafc 100%);
      line-height: 1.6;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
    }

    .hero {
      background: linear-gradient(135deg, #a98cf0 0%, #8869dc 48%, #6f52bf 100%);
      color: #fff;
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .hero h1 {
      margin: 0 0 8px;
      font-size: 1.5rem;
    }

    .hero p {
      margin: 6px 0;
      opacity: 0.96;
    }

    .progress-box {
      margin-top: 14px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 999px;
      height: 12px;
      overflow: hidden;
    }

    .progress {
      width: 0;
      height: 100%;
      background: #fff;
      transition: width .25s ease;
    }

    .panel {
      margin-top: 16px;
      background: var(--surface);
      border: 1px solid #f1f5f9;
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
    }

    h2 {
      margin: 0 0 12px;
      font-size: 1.08rem;
      color: var(--brand-deep);
    }

    h3 {
      margin: 0;
      font-size: 1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    label.field {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--ink-muted);
      margin-bottom: 4px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      font: inherit;
      color: var(--ink);
      background: #fff;
    }

    .q {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      margin-top: 12px;
      background: #fff;
    }

    .q h3 {
      margin: 0 0 8px;
    }

    .opt {
      position: relative;
      display: block;
      margin: 8px 0;
      border: 1.5px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 12px 12px 12px 42px;
      font-weight: 700;
      cursor: pointer;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }

    .opt:hover {
      border-color: #c4b5fd;
      box-shadow: 0 6px 14px rgba(111, 82, 191, 0.12);
    }

    .opt input,
    .opt input[type="checkbox"] {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      margin: 0;
    }

    .opt.selected {
      border-color: #8b5cf6;
      background: linear-gradient(180deg, #f7f3ff 0%, #f3edff 100%);
      box-shadow: 0 8px 16px rgba(111, 82, 191, 0.16);
    }

    .vocab-q h3 {
      margin-bottom: 12px;
      font-size: 1.05rem;
    }

    .vocab-choice-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .vocab-choice {
      position: relative;
      display: block;
      border: 1.5px solid var(--line);
      border-radius: 14px;
      background: #ffffff;
      padding: 16px 10px;
      text-align: center;
      font-weight: 800;
      font-size: 1.05rem;
      cursor: pointer;
      user-select: none;
      transition: border-color .18s ease, box-shadow .18s ease, transform .12s ease;
      min-height: 64px;
    }

    .vocab-choice:hover {
      border-color: #c4b5fd;
      box-shadow: 0 6px 14px rgba(111, 82, 191, 0.14);
      transform: translateY(-1px);
    }

    .vocab-choice input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      width: 0;
      height: 0;
    }

    .vocab-choice input:checked+span {
      color: #4c1d95;
    }

    .vocab-choice input:checked+span::after {
      content: "✓";
      margin-left: 8px;
      font-weight: 900;
    }

    .vocab-choice:has(input:checked) {
      border-color: #8b5cf6;
      background: linear-gradient(180deg, #f7f3ff 0%, #f3edff 100%);
      box-shadow: 0 8px 16px rgba(111, 82, 191, 0.18);
    }

    .vocab-choice.selected {
      border-color: #8b5cf6;
      background: linear-gradient(180deg, #f7f3ff 0%, #f3edff 100%);
      box-shadow: 0 8px 16px rgba(111, 82, 191, 0.18);
    }

    .two-col {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      text-decoration: none;
      border: 1px solid transparent;
      cursor: pointer;
      font: inherit;
    }

    .btn-primary {
      background: linear-gradient(130deg, var(--brand-deep), var(--brand));
      color: #fff;
      box-shadow: 0 8px 20px rgba(154, 127, 232, 0.25);
    }

    .btn-light {
      background: #fff;
      color: var(--ink);
      border-color: var(--line);
    }

    .btn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }

    .tip {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--ink-muted);
    }

    .error {
      margin-top: 15px;
      color: var(--bad);
      font-size: 1.15rem;
      font-weight: 700;
      padding: 10px;
      border: 1px solid var(--bad);
      border-radius: 8px;
      background-color: #fff5f5;
    }

    .upload-status {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      border: 1px solid var(--line);
      background: #f8fafc;
      color: var(--ink-muted);
    }

    .upload-status.ok {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: var(--ok);
    }

    .upload-status.warn {
      background: #fff7ed;
      border-color: #fed7aa;
      color: var(--warn);
    }

    .upload-status.bad {
      background: #fef2f2;
      border-color: #fecaca;
      color: var(--bad);
    }

    .result {
      margin-top: 16px;
      border-radius: 14px;
      padding: 14px;
      border: 1px solid var(--line);
      background: #fff;
    }

    .result.pass {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: var(--ok);
    }

    .result.fail {
      background: #fef2f2;
      border-color: #fecaca;
      color: var(--bad);
    }

    .result h3 {
      margin: 0 0 6px;
    }

    .hint {
      font-size: 0.85rem;
      color: var(--ink-muted);
    }

    .q12-note {
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #f8fafc;
    }

    .submit-progress {
      margin-top: 12px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fcfbff;
    }

    .submit-progress[hidden] {
      display: none;
    }

    .submit-progress p {
      margin: 0 0 8px;
      font-size: 0.9rem;
      color: var(--ink-muted);
      font-weight: 600;
    }

    .submit-progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #eee8ff;
      overflow: hidden;
    }

    .submit-progress-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(130deg, var(--brand-deep), var(--brand));
      transition: width .25s ease;
    }

    @media (max-width: 760px) {

      .grid,
      .two-col {
        grid-template-columns: 1fr;
      }

      .vocab-choice-grid {
        grid-template-columns: 1fr;
      }

      .wrap {
        padding: 14px;
      }
    }
  </style>
</head>

<body>··
  <div class="wrap">
    <section class="hero">
      <h1>Pre-screening Experiments / 预筛选实验</h1>
      <p>This questionnaire consists of <strong>two parts</strong>:<br>
        <strong>Part I</strong> is Chinese learners’ background information;<br>
        <strong>Part II</strong> is a Chinese two-character test.
      </p>
      <p>It will take <strong>5 minutes</strong> to complete the whole questionnaire.</p>
      <p>This study is for <strong>research purposes only</strong>. All data will be kept <strong>confidential</strong>
        and used solely for statistical analysis.</p>
      <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
      <p>本问卷由<strong>两部分</strong>组成：<br>
        <strong>第一部分</strong>为学习者个人背景信息调查；<br>
        <strong>第二部分</strong>为汉语双字词测试。
      </p>
      <p>整个问卷将耗时约<strong>5分钟</strong>。</p>
      <p>本研究仅用于<strong>学术研究</strong>，所有数据将<strong>严格保密</strong>，并仅用于统计分析。</p>

    </section>

    <section class="panel">
      <h2>自动上传设置 / Auto Upload Destination</h2>
      <div class="actions">
        <button id="retryUploadBtn" class="btn btn-light" type="button">重传失败记录 / Retry Pending Uploads</button>
      </div>
      <p class="tip">Responses will be uploaded automatically upon submission. In case of network failure, they will be
        queued locally; you can click "Retry Pending Uploads" later.</p>
      <p id="uploadStatus" class="upload-status" hidden></p>
    </section>

    <form id="quizForm" class="panel">
      <h2>Part I Chinese learners’ background information / 学习者个人背景信息调查</h2>

      <div class="q" data-bg="1">
        <h3>1. Name (姓名) <span class="hint">*</span></h3>
        <input name="q1_name" required />
      </div>

      <div class="q" data-bg="2">
        <h3>2. E-mail (邮箱) <span class="hint">*</span></h3>
        <input name="q2_email" type="email" required />
      </div>

      <div class="q" data-bg="3">
        <h3>3. Payment Method (收款方式) <span class="hint">*</span></h3>
        <select id="q2_payment_method" name="q2_payment_method" required>
          <option value="">Select / 请选择</option>
          <option value="WeChat (微信)">WeChat (微信)</option>
          <option value="Alipay (支付宝)">Alipay (支付宝)</option>
          <option value="PayPal">PayPal</option>
          <option value="Apple Pay">Apple Pay</option>
        </select>
        <label class="field" for="q2_payment_account" style="margin-top:10px;">Account Number / 收款账号 <span
            class="hint">*</span></label>
        <input id="q2_payment_account" name="q2_payment_account" placeholder="Enter payment account / 请输入收款账号"
          required />
      </div>

      <div class="q" data-bg="4">
        <h3>4. Age (年龄) <span class="hint">*</span></h3>
        <input name="q3_age" type="number" min="10" max="90" required />
      </div>

      <div class="q" data-bg="5">
        <h3>5. Gender (性别) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q4_gender" value="Male (男)" required />Male (男)</label>
        <label class="opt"><input type="radio" name="q4_gender" value="Female (女)" />Female (女)</label>
        <label class="opt"><input type="radio" name="q4_gender" value="Other (其他)" />Other (其他)</label>
      </div>

      <div class="q" data-bg="6">
        <h3>6. Nationality (国籍) <span class="hint">*</span></h3>
        <input name="q5_nationality" required />
      </div>

      <div class="q" data-bg="7">
        <h3>7. Native language(s) (multiple answers allowed) | 母语 (可多种) <span class="hint">*</span></h3>
        <input name="q6_native_languages" required placeholder="e.g., English; Spanish" />
      </div>

      <div class="q" data-bg="8">
        <h3>8. Have you ever been to China? (是否来过中国？) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q7_been_china" value="Yes (是)" required />Yes (是)</label>
        <label class="opt"><input type="radio" name="q7_been_china" value="No (否)" />No (否)</label>
        <label class="field" for="q7_detail" style="margin-top:10px;">Purpose and duration (目的与时长)</label>
        <input id="q7_detail" name="q7_detail" placeholder="Optional" />
      </div>

      <div class="q" data-bg="9">
        <h3>9. Total length of Chinese learning (excluding interruptions) | 累计学习汉语的时长 (不含中断时间) <span
            class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q8_learning_length" value="Less than 1 year (少于 1 年)"
            required />Less than 1 year (少于 1 年)</label>
        <label class="opt"><input type="radio" name="q8_learning_length" value="1–2 years (1–2 年)" />1–2 years (1–2
          年)</label>
        <label class="opt"><input type="radio" name="q8_learning_length" value="2–4 years (2–4 年)" />2–4 years (2–4
          年)</label>
        <label class="opt"><input type="radio" name="q8_learning_length" value="4–6 years (4–6 年)" />4–6 years (4–6
          年)</label>
        <label class="opt"><input type="radio" name="q8_learning_length" value="More than 6 years (6 年以上)" />More than 6
          years (6 年以上)</label>
      </div>

      <div class="q" data-bg="10">
        <h3>10. Main learning contexts (multiple answers allowed) | 学习汉语的主要方式或场所 (可多选) <span class="hint">*</span></h3>
        <label class="opt"><input type="checkbox" name="q9_contexts"
            value="University in home country (本国高校)" />University in home country (本国高校)</label>
        <label class="opt"><input type="checkbox" name="q9_contexts" value="University in China (中国高校)" />University in
          China (中国高校)</label>
        <label class="opt"><input type="checkbox" name="q9_contexts" value="Language institute (语言培训机构)" />Language
          institute (语言培训机构)</label>
        <label class="opt"><input type="checkbox" name="q9_contexts" value="Online courses (线上课程)" />Online courses
          (线上课程)</label>
        <label class="opt"><input type="checkbox" name="q9_contexts" value="Self-study (自学)" />Self-study (自学)</label>
        <label class="opt"><input type="checkbox" id="q9_other_chk" name="q9_contexts" value="Other (其他)" />Other
          (其他)</label>
        <label class="field" for="q9_other" style="margin-top:10px;">Other details (其他说明)</label>
        <input id="q9_other" name="q9_other" placeholder="Optional" />
      </div>

      <div class="q" data-bg="11">
        <h3>11. Current Chinese proficiency (self-rated) | 目前的汉语水平 (自评) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Beginner (初级入门)" required />Beginner
          (初级入门)</label>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Elementary (基础)" />Elementary (基础)</label>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Intermediate (中级)" />Intermediate
          (中级)</label>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Advanced (高级)" />Advanced (高级)</label>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Proficient (精通级)" />Proficient
          (精通级)</label>
        <label class="opt"><input type="radio" name="q10_proficiency" value="Near-native (接近母语水平)" />Near-native
          (接近母语水平)</label>
      </div>

      <div class="q" data-bg="12">
        <h3>12. Highest HSK level obtained (已获得的最高HSK等级) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q11_hsk" value="Never taken (未参加过)" required />Never taken
          (未参加过)</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 1" />HSK 1</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 2" />HSK 2</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 3" />HSK 3</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 4" />HSK 4</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 5" />HSK 5</label>
        <label class="opt"><input type="radio" name="q11_hsk" value="HSK 6" />HSK 6</label>
      </div>

      <div class="q" data-bg="13">
        <h3>13. Please upload your Chinese proficiency certificate, ideally the HSK. Preference will be given to those
          who hold an HSK certificate. (请上传您的汉语水平证书，最好是HSK证书。有该证书者优先考虑。) <span class="hint">*</span></h3>
        <div class="q12-note">
          <label class="opt"><input type="checkbox" name="q12_send_by_email" value="yes" />I will send the certificate
            as an email attachment / 我将通过邮件附件发送证书</label>
          <label class="field" for="q12_certificate_url" style="margin-top:8px;">Or provide an accessible URL /
            或填写可访问的在线地址</label>
          <input id="q12_certificate_url" name="q12_certificate_url" placeholder="https://..." />
        </div>
      </div>

      <div class="q" data-bg="14">
        <h3>14. Date of the most recent passed HSK test (Year/Month) | 最近一次通过HSK的时间 (年/月)</h3>
        <input name="q13_hsk_date" placeholder="Optional: e.g., 2025/10" />
      </div>

      <div class="q" data-bg="15">
        <h3>15. Primary motivation for learning Chinese (学习汉语的主要动机) <span class="hint">*</span></h3>
        <label class="opt"><input type="radio" name="q14_motivation" value="Academic (学业)" required />Academic
          (学业)</label>
        <label class="opt"><input type="radio" name="q14_motivation" value="Work (工作)" />Work (工作)</label>
        <label class="opt"><input type="radio" name="q14_motivation" value="Personal interest (个人兴趣)" />Personal
          interest (个人兴趣)</label>
        <label class="opt"><input type="radio" name="q14_motivation" value="Other (其他)" />Other (其他)</label>
      </div>

      <h2 style="margin-top:18px;">Part II Chinese Two-Character Test</h2>
      <div class="tip" style="margin-bottom: 20px; line-height: 1.6;">
        <p>You will see <strong>60 two-character sequences</strong>. Only some of them are <strong>real Chinese
            words</strong>, e.g., 科学. Your task is to decide whether each sequence is an existing Chinese word or not.
        </p>
        <p>If you think the sequence is an <strong>existing</strong> Chinese word, you select <strong>"Yes"</strong>. If
          you are <strong>sure</strong> that the word exists in Chinese, even though you do not know its exact meaning
          or pronunciation, you may still select <strong>"Yes"</strong>.</p>
        <p>If you think the sequence is <strong>not an existing</strong> Chinese word, you select <strong>"No"</strong>.
          If you are <strong>not sure</strong> if it is an existing word in Chinese, you should still select
          <strong>"No"</strong>.
        </p>
        <p>You <strong>do not need to respond rapidly</strong>, but please give your <strong>first impression</strong>,
          without any outside aids (i.e., <strong>do not consult a dictionary!</strong>). Each sequence will be
          presented in <strong>Simplified Chinese</strong>.</p>
        <hr style="margin: 15px 0; border: 0; border-top: 1px dashed #ccc;">
        <p>您将看到<strong>60个双字词组合</strong>。其中只有一部分是<strong>真实的中文词语</strong>，例如“科学”。请判断每个组合是否是一个现存的中文词语。</p>
        <p>
          如果您认为该词组是一个<strong>现存</strong>的中文词语，请选择<strong>“是”</strong>；如果您<strong>确定</strong>这个词组在中文中存在，即使您不知道它的确切含义或发音，仍然可以选择<strong>“是”</strong>。
        </p>
        <p>
          如果您认为该词组<strong>不是</strong>一个现存的中文词语，请选择<strong>“否”</strong>；如果您<strong>不确定</strong>这个词组在中文中是否存在，您依旧应该选择<strong>“否”</strong>。
        </p>
        <p>
          您<strong>不需要快速回答</strong>，但请根据<strong>第一印象</strong>判断，不要借助任何外部帮助（即<strong>不要查阅词典！</strong>）。每个词组将以<strong>简体中文</strong>形式呈现。
        </p>
      </div>
      <div id="vocabQuestions"></div>

      <div class="actions">
        <button class="btn btn-primary" type="submit">计算得分 / Calculate Score</button>
      </div>
      <p id="errorMsg" class="error" style="margin-bottom: 20px;" hidden></p>

      <div id="submitProgressBox" class="submit-progress" hidden>
        <p id="submitProgressText">处理中...</p>
        <div class="submit-progress-bar">
          <div id="submitProgressFill" class="submit-progress-fill"></div>
        </div>
      </div>
      <p class="tip">Test results will be <strong>automatically uploaded</strong> to Google Sheets and a summary will be
        generated upon submission. / 测试结果将<strong>自动上传</strong>至 Google Sheets，提交后系统将生成结果摘要。</p>
      <p class="tip"
        style="color: #d9534f; background: #fdf7f7; padding: 10px; border-radius: 4px; border-left: 5px solid #d9534f;">
        <strong>IMPORTANT:</strong> To avoid data loss due to potential network issues, please also click
        <strong>"Send Result via Email"</strong> or <strong>"Save as File"</strong> to send your results manually. This
        step is <strong>essential</strong> to ensure your participation is valid.
        <br><br>
        <strong>重要提示：</strong>为保障实验有效性，提交后请务必点击<strong>“通过邮箱发送结果”</strong>或<strong>“保存为文件”</strong>手动发送数据备份，以防止自动上传失效。
      </p>

      <div id="resultBox" class="result" hidden>
        <h3 id="resultTitle"></h3>
        <p id="resultText"></p>
        <div class="actions" style="flex-wrap: wrap; gap: 10px;">
          <a id="sendEmailBtn" class="btn btn-primary" href="#">通过邮箱发送结果 / Send Result via Email</a>
          <button id="saveFileBtn" class="btn btn-primary" type="button"
            style="background-color: #28a745; border-color: #28a745;">保存为文件 (稍后手动发送) / Save as File (Send Manually
            Later)</button>
          <a id="nextBtn" class="btn btn-light" href="./index.html">返回主页面 / Back to Main Page</a>
        </div>
      </div>
    </form>
  </div>

  <script>
    const VOCAB_WORDS = [
      "涟漪", "熟悉", "璀璨", "缤纂", "慷慨", "朦胧", "恍惚", "挫治", "痊愈", "抹哦",
      "咸裕", "问题", "匍匐", "狰狞", "憧憬", "祈祷", "呻椒", "寂寞", "囊港", "烹饪",
      "涵浅", "瑕疵", "巅妾", "漆蝠", "襁褓", "傀儡", "晴榻", "瘫痪", "磷祥", "俸禄",
      "抒汞", "喉咙", "滂沱", "骄傲", "卑鄙", "亦筷", "脂肪", "唠叨", "糖描", "囫囵",
      "淘汰", "愤怒", "邋遢", "裳妊", "亵渎", "诠疮", "蹉跎", "蹂躏", "契砣", "贿赂",
      "瘟疫", "咳嗽", "鹤棋", "羡慕", "颁昧", "吩咐", "掌握", "惆怅", "晶嫩", "徘徊"
    ];
    const VOCAB_ANSWER_KEY = [
      true, true, true, false, true, true, true, false, true, false,
      false, true, true, true, true, true, false, true, false, true,
      false, true, false, false, true, true, false, true, false, true,
      false, true, true, true, true, false, true, true, false, true,
      true, true, true, false, true, false, true, true, false, true,
      true, true, false, true, false, true, true, true, false, true
    ];

    const form = document.getElementById("quizForm");
    const errorMsg = document.getElementById("errorMsg");
    const resultBox = document.getElementById("resultBox");
    const resultTitle = document.getElementById("resultTitle");
    const resultText = document.getElementById("resultText");
    const sendEmailBtn = document.getElementById("sendEmailBtn");
    const saveFileBtn = document.getElementById("saveFileBtn");
    const nextBtn = document.getElementById("nextBtn");
    const retryUploadBtn = document.getElementById("retryUploadBtn");
    const uploadStatus = document.getElementById("uploadStatus");
    const vocabQuestionsEl = document.getElementById("vocabQuestions");
    const submitBtn = form.querySelector('button[type="submit"]');
    const submitProgressBox = document.getElementById("submitProgressBox");
    const submitProgressText = document.getElementById("submitProgressText");
    const submitProgressFill = document.getElementById("submitProgressFill");

    const FIRST_VOCAB_TOPIC = 1;
    const TOTAL_QUESTIONS = VOCAB_WORDS.length;
    const PASS_SCORE = 25;
    const BACKGROUND_PROGRESS_TOTAL = 14;
    const UPLOAD_QUEUE_KEY = "preScreenUploadQueue";
    const FIXED_UPLOAD_ENDPOINT = "https://script.google.com/macros/s/AKfycbznGbiTo1433zPLbHKUtsJnrmsjpcB0-uZAgKQd3wagPpY3PFVFzRurokxdLzDnOmviMQ/exec";

    let currentMailInfo = { subject: "", body: "", name: "" };

    function downloadAsFile(text, filename) {
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    sendEmailBtn.addEventListener("click", (e) => {
      let focusLost = false;
      const onBlur = () => { focusLost = true; };
      window.addEventListener("blur", onBlur);

      setTimeout(() => {
        window.removeEventListener("blur", onBlur);
        if (!focusLost) {
          const msg = "It seems no email client is configured on your computer.\n\nWould you like to save the results as a text file? You can then manually send this file to: liuhuanpsylanguage@foxmail.com\n\n系统未检测到可用的邮箱应用。是否将结果保存为文件，以便您手动发送至 liuhuanpsylanguage@foxmail.com？";
          if (confirm(msg)) {
            const fileName = `PreScreen_${currentMailInfo.name || "Participant"}_${new Date().getTime()}.txt`;
            downloadAsFile(currentMailInfo.body, fileName);
          }
        }
      }, 2000);
    });

    saveFileBtn.addEventListener("click", () => {
      const fileName = `PreScreen_${currentMailInfo.name || "Participant"}_${new Date().getTime()}.txt`;
      downloadAsFile(currentMailInfo.body, fileName);
    });

    function renderVocabQuestions() {
      vocabQuestionsEl.innerHTML = VOCAB_WORDS.map((word, idx) => {
        const topic = FIRST_VOCAB_TOPIC + idx;
        return `
          <div class="q vocab-q" data-topic="${topic}" data-word="${word}">
            <h3>${topic}. ${word}</h3>
            <div class="vocab-choice-grid">
              <label class="vocab-choice">
                <input type="radio" name="vocab_${topic}" value="Yes (是)" required />
                <span>Yes (是)</span>
              </label>
              <label class="vocab-choice">
                <input type="radio" name="vocab_${topic}" value="No (否)" />
                <span>No (否)</span>
              </label>
            </div>
          </div>
        `;
      }).join("");
    }

    function setUploadStatus(message, type = "") {
      uploadStatus.className = `upload-status ${type}`.trim();
      uploadStatus.textContent = message;
      uploadStatus.hidden = !message;
    }

    function getQueue() {
      try {
        return JSON.parse(localStorage.getItem(UPLOAD_QUEUE_KEY) || "[]");
      } catch (_) {
        return [];
      }
    }

    function saveQueue(queue) {
      localStorage.setItem(UPLOAD_QUEUE_KEY, JSON.stringify(queue));
    }

    function enqueueResult(resultData) {
      try {
        const queue = getQueue();
        queue.push(resultData);
        saveQueue(queue);
        return queue.length;
      } catch (_) {
        return -1;
      }
    }

    async function uploadToEndpoint(payload) {
      const endpoint = FIXED_UPLOAD_ENDPOINT;
      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error(`http-${response.status}`);
        }
        return { ok: true, verified: true };
      } catch (_) {
        try {
          await fetch(endpoint, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(payload)
          });
          return { ok: true, verified: false, reason: "opaque-no-cors" };
        } catch (_) {
          return { ok: false, reason: "network-error" };
        }
      }
    }

    async function retryPendingUploads() {
      const queue = getQueue();
      if (!queue.length) {
        setUploadStatus("No pending records to upload.", "ok");
        return;
      }
      const remaining = [];
      let successCount = 0;
      let unverifiedCount = 0;
      for (const item of queue) {
        const res = await uploadToEndpoint(item);
        if (res.ok) {
          if (res.verified === false) {
            unverifiedCount += 1;
          } else {
            successCount += 1;
          }
        } else {
          remaining.push(item);
        }
      }
      saveQueue(remaining);
      if (remaining.length === 0) {
        retryUploadBtn.textContent = "✅ Upload Successful / 重传成功";
        if (unverifiedCount > 0) {
          setUploadStatus(`Upload completed: ${successCount} verified, ${unverifiedCount} sent but unverified (likely due to CORS).`, "ok");
        } else {
          setUploadStatus(`Upload completed: ${successCount} records sent successfully.`, "ok");
        }
      } else {
        setUploadStatus(`Upload completed: ${successCount} successfully verified, ${unverifiedCount} sent but unverified, ${remaining.length} failed.`, "warn");
      }
    }

    function checkBackgroundRequired() {
      if (!form.q1_name.value.trim()) return "Please fill in Question 1 (Name).";
      if (!form.q2_email.value.trim()) return "Please fill in Question 2 (Email).";
      if (!form.q2_payment_method.value.trim()) return "Please select a payment method in Question 3.";
      if (!form.q2_payment_account.value.trim()) return "Please fill in your payment account in Question 3.";
      if (!form.q3_age.value.trim()) return "Please fill in Question 4 (Age).";
      if (!form.querySelector('input[name="q4_gender"]:checked')) return "Please complete Question 5 (Gender).";
      if (!form.q5_nationality.value.trim()) return "Please fill in Question 6 (Nationality).";
      if (!form.q6_native_languages.value.trim()) return "Please fill in Question 7 (Native language).";
      if (!form.querySelector('input[name="q7_been_china"]:checked')) return "Please complete Question 8 (China visit).";
      if (!form.querySelector('input[name="q8_learning_length"]:checked')) return "Please complete Question 9 (Learning length).";
      if (form.querySelectorAll('input[name="q9_contexts"]:checked').length === 0) return "Please select at least one learning context in Question 10.";
      if (!form.querySelector('input[name="q10_proficiency"]:checked')) return "Please complete Question 11 (Proficiency).";
      if (!form.querySelector('input[name="q11_hsk"]:checked')) return "Please complete Question 12 (HSK level).";
      const q13SendByEmail = !!form.querySelector('input[name="q12_send_by_email"]:checked');
      const q13Url = form.q12_certificate_url.value.trim();
      if (!q13SendByEmail && !q13Url) return "Please complete Question 13 (Certificate): either select email attachment or provide a URL.";
      if (q13Url && !(q13Url.startsWith("http://") || q13Url.startsWith("https://"))) return "Question 13 URL must start with http:// or https://.";
      if (!form.querySelector('input[name="q14_motivation"]:checked')) return "Please complete Question 15 (Motivation).";
      return "";
    }

    function getBackgroundAnsweredCount() {
      let answered = 0;
      if (form.q1_name.value.trim()) answered += 1;
      if (form.q2_email.value.trim() && form.q2_payment_method.value.trim() && form.q2_payment_account.value.trim()) answered += 1;
      if (form.q3_age.value.trim()) answered += 1;
      if (form.querySelector('input[name="q4_gender"]:checked')) answered += 1;
      if (form.q5_nationality.value.trim()) answered += 1;
      if (form.q6_native_languages.value.trim()) answered += 1;
      if (form.querySelector('input[name="q7_been_china"]:checked')) answered += 1;
      if (form.querySelector('input[name="q8_learning_length"]:checked')) answered += 1;
      if (form.querySelectorAll('input[name="q9_contexts"]:checked').length > 0) answered += 1;
      if (form.querySelector('input[name="q10_proficiency"]:checked')) answered += 1;
      if (form.querySelector('input[name="q11_hsk"]:checked')) answered += 1;
      const q12SendByEmail = !!form.querySelector('input[name="q12_send_by_email"]:checked');
      const q12Url = form.q12_certificate_url.value.trim();
      if (q12SendByEmail || q12Url) answered += 1;
      if (form.q13_hsk_date.value.trim()) answered += 1;
      if (form.querySelector('input[name="q14_motivation"]:checked')) answered += 1;
      return answered;
    }

    function updateProgress() {
      let vocabAnswered = 0;
      for (let i = 0; i < VOCAB_WORDS.length; i++) {
        const topic = FIRST_VOCAB_TOPIC + i;
        if (form.querySelector(`input[name="vocab_${topic}"]:checked`)) vocabAnswered += 1;
      }
      const backgroundAnswered = getBackgroundAnsweredCount();
      const totalAnswered = backgroundAnswered + vocabAnswered;
      const totalCount = BACKGROUND_PROGRESS_TOTAL + TOTAL_QUESTIONS;
      // Progress calculation removed to keep UI simple
    }

    function refreshVocabSelectionStyles() {
      document.querySelectorAll(".vocab-q").forEach((q) => {
        q.querySelectorAll(".vocab-choice").forEach((label) => label.classList.remove("selected"));
        const checked = q.querySelector('input[type="radio"]:checked');
        if (checked && checked.parentElement && checked.parentElement.classList.contains("vocab-choice")) {
          checked.parentElement.classList.add("selected");
        }
      });
    }

    function refreshGeneralOptionStyles() {
      document.querySelectorAll(".q:not(.vocab-q) .opt").forEach((label) => {
        const input = label.querySelector("input");
        if (input && input.checked) {
          label.classList.add("selected");
        } else {
          label.classList.remove("selected");
        }
      });
    }

    function setSubmitProgress(percent, text) {
      submitProgressBox.hidden = false;
      submitProgressFill.style.width = `${Math.max(0, Math.min(100, percent))}%`;
      submitProgressText.textContent = text;
    }

    function resetSubmitProgress() {
      submitProgressBox.hidden = true;
      submitProgressFill.style.width = "0%";
      submitProgressText.textContent = "Processing...";
    }

    function getBeijingTimestamp() {
      const parts = new Intl.DateTimeFormat("sv-SE", {
        timeZone: "Asia/Shanghai",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      }).formatToParts(new Date()).reduce((acc, part) => {
        if (part.type !== "literal") acc[part.type] = part.value;
        return acc;
      }, {});

      return `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}+08:00`;
    }

    retryUploadBtn.addEventListener("click", retryPendingUploads);
    form.addEventListener("change", () => {
      updateProgress();
      refreshVocabSelectionStyles();
      refreshGeneralOptionStyles();
    });
    form.addEventListener("input", updateProgress);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorMsg.hidden = true;
      resultBox.hidden = true;
      submitBtn.disabled = true;
      setSubmitProgress(6, "Validating required information...");
      try {

        const bgError = checkBackgroundRequired();
        if (bgError) {
          errorMsg.textContent = bgError;
          errorMsg.hidden = false;
          submitBtn.disabled = false;
          resetSubmitProgress();
          return;
        }

        for (let i = 0; i < VOCAB_WORDS.length; i++) {
          const topic = FIRST_VOCAB_TOPIC + i;
          if (!form.querySelector(`input[name="vocab_${topic}"]:checked`)) {
            errorMsg.textContent = `Please complete Question ${topic} before submitting.`;
            errorMsg.hidden = false;
            submitBtn.disabled = false;
            resetSubmitProgress();
            return;
          }
        }
        setSubmitProgress(28, "Calculating score...");

        setSubmitProgress(38, "Preparing submission data...");

        const q12SendByEmail = !!form.querySelector('input[name="q12_send_by_email"]:checked');
        const q12Url = form.q12_certificate_url.value.trim();
        const q12Methods = [];
        if (q12SendByEmail) q12Methods.push("Email attachment / 邮件附件");
        if (q12Url) q12Methods.push(`Online URL / 在线地址: ${q12Url}`);

        const candidate = {
          name: form.q1_name.value.trim(),
          email: form.q2_email.value.trim(),
          paymentMethod: form.q2_payment_method.value.trim(),
          paymentAccount: form.q2_payment_account.value.trim(),
          age: form.q3_age.value.trim(),
          gender: form.querySelector('input[name="q4_gender"]:checked').value,
          nationality: form.q5_nationality.value.trim(),
          nativeLanguages: form.q6_native_languages.value.trim(),
          beenToChina: form.querySelector('input[name="q7_been_china"]:checked').value,
          chinaVisitDetail: form.q7_detail.value.trim(),
          learningLength: form.querySelector('input[name="q8_learning_length"]:checked').value,
          learningContexts: Array.from(form.querySelectorAll('input[name="q9_contexts"]:checked')).map((el) => el.value),
          learningContextsOther: form.q9_other.value.trim(),
          proficiency: form.querySelector('input[name="q10_proficiency"]:checked').value,
          highestHSK: form.querySelector('input[name="q11_hsk"]:checked').value,
          certificateInfo: q12Methods.join(" | "),
          latestHSKDate: form.q13_hsk_date.value.trim(),
          motivation: form.querySelector('input[name="q14_motivation"]:checked').value,
          wechat: ""
        };

        const vocabAnswers = [];
        let correctCount = 0;
        for (let i = 0; i < VOCAB_WORDS.length; i++) {
          const topic = FIRST_VOCAB_TOPIC + i;
          const word = VOCAB_WORDS[i];
          const chosen = form.querySelector(`input[name="vocab_${topic}"]:checked`).value;
          const chosenYes = chosen === "Yes (是)";
          const expectedYes = VOCAB_ANSWER_KEY[i];
          const isCorrect = chosenYes === expectedYes;
          if (isCorrect) correctCount += 1;
          vocabAnswers.push({
            question: topic,
            word,
            chosen,
            correct: expectedYes ? "Yes (是)" : "No (否)",
            isCorrect
          });
        }

        const score = correctCount;
        const total = TOTAL_QUESTIONS;

        // Pass conditions: Score > 25, HSK 3-6, and Native language is English
        const scorePassed = score > PASS_SCORE;
        const hskPassed = ["HSK 3", "HSK 4", "HSK 5", "HSK 6"].includes(candidate.highestHSK);
        const langLower = candidate.nativeLanguages.toLowerCase();
        const langPassed = langLower.includes("english") || langLower.includes("英语");

        const passed = scorePassed && hskPassed && langPassed;

        const submittedAt = getBeijingTimestamp();
        const uploadPayload = {
          status: passed ? "pass" : "fail",
          score,
          total,
          passThreshold: `Score>${PASS_SCORE}, HSK>2, Native=English`,
          candidate,
          answers: vocabAnswers,
          submittedAt
        };

        const resultData = {
          status: uploadPayload.status,
          score: uploadPayload.score,
          total: uploadPayload.total,
          passThreshold: uploadPayload.passThreshold,
          candidate,
          answers: uploadPayload.answers,
          submittedAt
        };
        setSubmitProgress(48, "Saving local results...");

        localStorage.setItem("preScreenResult", JSON.stringify(resultData));

        setSubmitProgress(70, "Uploading to Google Sheets...");
        const uploadRes = await uploadToEndpoint(uploadPayload);
        if (uploadRes.ok) {
          if (uploadRes.verified === false) {
            submitBtn.textContent = "✅ Uploaded to Google Sheets";
            setUploadStatus("Auto-upload sent, but response could not be verified by browser (common due to CORS). Please check the database to confirm.", "warn");
          } else {
            submitBtn.textContent = "✅ Uploaded to Google Sheets";
            setUploadStatus("Auto-upload successful.", "ok");
          }
        } else {
          const pendingCount = enqueueResult(resultData);
          if (pendingCount === -1) {
            setUploadStatus("Auto-upload failed and local cache is full. Please try again when the network is stable.", "bad");
          } else {
            setUploadStatus(`Auto-upload failed; result added to pending queue (${pendingCount} records).`, "bad");
          }
        }
        setSubmitProgress(86, "Generating result page...");

        const mailSubject = passed
          ? `Pre-screening PASSED | ${candidate.name} | Score ${score}/${total}`
          : `Pre-screening FAILED | ${candidate.name} | Score ${score}/${total}`;

        const bgLines = [
          `Q1 Name: ${candidate.name}`,
          `Q2 Email: ${candidate.email}`,
          `Q2 Payment method: ${candidate.paymentMethod}`,
          `Q2 Payment account: ${candidate.paymentAccount}`,
          `Q3 Age: ${candidate.age}`,
          `Q4 Gender: ${candidate.gender}`,
          `Q5 Nationality: ${candidate.nationality}`,
          `Q6 Native languages: ${candidate.nativeLanguages}`,
          `Q7 Been to China: ${candidate.beenToChina}`,
          `Q7 Detail: ${candidate.chinaVisitDetail || "N/A"}`,
          `Q8 Learning length: ${candidate.learningLength}`,
          `Q9 Contexts: ${candidate.learningContexts.join("; ")}${candidate.learningContextsOther ? ` | Other: ${candidate.learningContextsOther}` : ""}`,
          `Q10 Proficiency: ${candidate.proficiency}`,
          `Q11 Highest HSK: ${candidate.highestHSK}`,
          `Q12 Certificate info: ${candidate.certificateInfo || "N/A"}`,
          `Q13 Latest passed HSK date: ${candidate.latestHSKDate || "N/A"}`,
          `Q14 Motivation: ${candidate.motivation}`
        ].join("\n");

        const answerLines = vocabAnswers
          .map((a) => `Q${a.question} ${a.word}: chosen=${a.chosen}, correct=${a.correct}, result=${a.isCorrect ? "correct" : "wrong"}`)
          .join("\n");

        const mailBody = [
          "Pre-screening Result",
          "-------------------",
          `Status: ${passed ? "PASSED" : "FAILED"}`,
          `Score: ${score}/${total}`,
          `Rule: score > ${PASS_SCORE} means pass.`,
          "",
          "Background Information",
          bgLines,
          "",
          "Vocabulary Answers",
          answerLines,
          "",
          `Submitted At: ${resultData.submittedAt}`
        ].join("\n");

        currentMailInfo = {
          subject: mailSubject,
          body: mailBody,
          name: candidate.name
        };

        sendEmailBtn.href = `mailto:liuhuanpsylanguage@foxmail.com?subject=${encodeURIComponent(mailSubject)}&body=${encodeURIComponent(mailBody)}`;

        if (passed) {
          resultBox.className = "result pass";
          resultTitle.textContent = "Congratulations!";
          resultText.textContent = "Congratulations on passing the pre-screening test and entering the third step to participate in the main experiment! (恭喜您通过预筛选实验，可进入第三步，参加正式实验！)";
          nextBtn.href = "./index.html#step3-section";
          nextBtn.textContent = "Go to Step 3";
        } else {
          resultBox.className = "result fail";
          resultTitle.textContent = "Notice / 提示";
          resultText.textContent = "Unfortunately, you did not pass the pre-screening test and cannot participate in the main experiment. (很遗憾您没有通过预实验，无法参加正式实验。)";
          nextBtn.href = "./index.html";
          nextBtn.textContent = "Back to Main Page";
        }

        setSubmitProgress(100, "Processing Complete");
        resultBox.hidden = false;
        resultBox.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => {
          resetSubmitProgress();
          submitBtn.disabled = false;
        }, 600);
      } catch (err) {
        console.error("Submission error:", err);
        errorMsg.textContent = "An error occurred during processing. Please try again later. Error: " + err.message;
        errorMsg.hidden = false;
        resetSubmitProgress();
        submitBtn.disabled = false;
      }
    });

    renderVocabQuestions();
    const queued = getQueue().length;
    setUploadStatus(
      queued ? `当前有 ${queued} 条待上传记录。` : ""
    );
    updateProgress();
    refreshVocabSelectionStyles();
    refreshGeneralOptionStyles();
  </script>
</body>

</html>